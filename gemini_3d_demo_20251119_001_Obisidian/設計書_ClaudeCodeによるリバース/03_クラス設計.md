# 03. クラス設計

> [!abstract] 概要
> 本ドキュメントは全クラスのプロパティ、メソッド、シグネチャを定義します。このドキュメントを参照して各クラスのスケルトンを実装できます。

---

## クラス一覧

| クラス | ファイル | 行数 | カテゴリ |
|-------|---------|------|---------|
| Game | Game.js | 240 | コア |
| Entity | Entity.js | 49 | エンティティ |
| EntityManager | EntityManager.js | 36 | エンティティ |
| Player | Player.js | 63 | プレイヤー |
| PlayerMesh | PlayerMesh.js | 354 | プレイヤー |
| PlayerPhysics | PlayerPhysics.js | 175 | プレイヤー |
| PlayerCombat | PlayerCombat.js | 106 | プレイヤー |
| PlayerCollision | PlayerCollision.js | 38 | プレイヤー |
| Slime | Slime.js | 206 | エンティティ |
| SlimeState | Slime.js | - | エンティティ |
| AliveState | Slime.js | - | エンティティ |
| DeadState | Slime.js | - | エンティティ |
| Block | Block.js | 99 | エンティティ |
| Tree | Tree.js | 74 | エンティティ |
| Rock | Rock.js | 79 | エンティティ |
| Input | Input.js | 116 | システム |
| CameraManager | CameraManager.js | 74 | システム |
| WorldManager | WorldManager.js | 47 | システム |
| BuildSystem | BuildSystem.js | 170 | システム |
| SaveManager | SaveManager.js | 189 | システム |
| SaveLoadUI | SaveLoadUI.js | 178 | システム |
| AudioManager | AudioManager.js | 109 | システム |

---

## コアクラス

### Game

**ファイル**: `src/Game.js`
**役割**: ゲーム全体の統合、メインループ

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| scene | THREE.Scene | new THREE.Scene() | 3Dシーン |
| camera | THREE.PerspectiveCamera | - | メインカメラ |
| renderer | THREE.WebGLRenderer | - | WebGLレンダラー |
| audioManager | AudioManager | - | 音声管理 |
| input | Input | - | 入力管理 |
| entityManager | EntityManager | - | エンティティ管理 |
| player | Player | - | プレイヤー |
| collidables | Array<THREE.Mesh> | [] | 衝突対象配列 |
| worldManager | WorldManager | - | ワールド管理 |
| buildSystem | BuildSystem | - | 建築システム |
| clock | THREE.Clock | new THREE.Clock() | 時間管理 |
| cameraManager | CameraManager | - | カメラ管理 |
| saveManager | SaveManager | - | セーブ管理 |
| saveLoadUI | SaveLoadUI | - | セーブUI |
| lastSaveTime | number | 0 | 最終セーブ時刻 |
| lastLoadTime | number | 0 | 最終ロード時刻 |
| lastMenuTime | number | 0 | 最終メニュー時刻 |
| notification | HTMLDivElement | - | 通知DOM要素 |
| notificationTimeout | number | - | 通知タイマーID |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor() | - | - | 全システム初期化 |
| createInitialCastle() | - | void | 初期城構造物を生成 |
| createNotificationUI() | - | void | 通知UI要素を作成 |
| showNotification(message, duration?) | message: string, duration?: number | void | 通知を表示 |
| start() | - | void | ゲームループ開始 |
| onWindowResize() | - | void | ウィンドウリサイズ処理 |
| render() | - | void | 毎フレーム処理（メインループ） |

---

## エンティティクラス

### Entity（基底クラス）

**ファイル**: `src/Entity.js`
**役割**: 全エンティティの基底クラス

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| type | string | 'Entity' | エンティティ種別 |
| mesh | THREE.Object3D \| null | null | 3Dメッシュ |
| _position | THREE.Vector3 | new Vector3() | 内部位置 |
| shouldRemove | boolean | false | 削除フラグ |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| get position() | - | THREE.Vector3 | 位置getter |
| set position(value) | value: THREE.Vector3 | - | 位置setter（mesh同期） |
| update(delta, input, time, collidables, entities) | delta: number, input: object, time: number, collidables: Array, entities: Array | void | 毎フレーム更新 |
| handleCollision(player, physics) | player: Player, physics: PlayerPhysics | void | 衝突処理 |
| isAlive() | - | boolean | 生存判定 |
| isSaveable() | - | boolean | 保存対象か |
| toSaveData() | - | object \| null | セーブデータ生成 |
| static fromSaveData(data) | data: object | Entity \| null | セーブデータから復元 |

### EntityManager

**ファイル**: `src/EntityManager.js`
**役割**: エンティティの追加・削除・更新管理

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| scene | THREE.Scene | - | シーン参照 |
| entities | Array<Entity> | [] | 管理中エンティティ |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(scene) | scene: THREE.Scene | - | 初期化 |
| add(entity) | entity: Entity | void | エンティティ追加 |
| remove(entity) | entity: Entity | void | エンティティ削除 |
| update(delta, input, time, collidables) | delta: number, input: object, time: number, collidables: Array | void | 全エンティティ更新 |

### Slime

**ファイル**: `src/Slime.js`
**継承**: Entity
**役割**: スライム敵キャラクター

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| type | string | 'Slime' | エンティティ種別 |
| position | THREE.Vector3 | (x, 0.5, z) | 位置 |
| originalY | number | 0.5 | 基準Y座標 |
| timeOffset | number | Math.random() * 100 | アニメーションオフセット |
| bounceSpeed | number | 3.0 | バウンス速度 |
| bounceHeight | number | 0.3 | バウンス高さ |
| currentState | SlimeState | AliveState | 現在のステート |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(x, z) | x: number, z: number | - | 初期化 |
| setState(newState) | newState: SlimeState | void | ステート変更 |
| handleCollision(player, physics) | player: Player, physics: PlayerPhysics | void | 衝突委譲 |
| update(delta, input, time) | delta: number, input: object, time: number | void | 更新委譲 |
| takeDamage() | - | void | ダメージ処理委譲 |
| createFeltTexture(colorHex) | colorHex: string | THREE.CanvasTexture | テクスチャ生成 |
| buildSlime() | - | THREE.Group | メッシュ構築 |
| isSaveable() | - | boolean | 生存時のみtrue |
| toSaveData() | - | object | {type, x, z} |
| static fromSaveData(data) | data: object | Slime | 復元 |

### Block

**ファイル**: `src/Block.js`
**継承**: Entity
**役割**: 配置可能なブロック

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| type | string | 'Block' | エンティティ種別 |
| blockType | string | - | ブロック種別 |
| position | THREE.Vector3 | (x, y, z) | 位置 |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(x, y, z, type) | x: number, y: number, z: number, type: string | - | 初期化 |
| createFeltTexture(colorHex) | colorHex: string | THREE.CanvasTexture | テクスチャ生成 |
| createMesh(x, y, z, type) | x: number, y: number, z: number, type: string | THREE.Mesh | メッシュ生成 |
| isSaveable() | - | boolean | 常にtrue |
| toSaveData() | - | object | {type, x, y, z, blockType} |
| static fromSaveData(data) | data: object | Block | 復元 |

---

## プレイヤークラス

### Player

**ファイル**: `src/Player.js`
**役割**: プレイヤーの統合クラス

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| scene | THREE.Scene | - | シーン参照 |
| audioManager | AudioManager | - | 音声管理参照 |
| position | THREE.Vector3 | (0, 0, 0) | 位置 |
| mesh | THREE.Group | - | 3Dモデル |
| physics | PlayerPhysics | - | 物理コンポーネント |
| combat | PlayerCombat | - | 戦闘コンポーネント |
| collision | PlayerCollision | - | 衝突コンポーネント |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(scene, audioManager) | scene: THREE.Scene, audioManager: AudioManager | - | 初期化 |
| buildCharacter() | - | THREE.Group | PlayerMeshでモデル生成 |
| update(delta, input, time, collidables, entities) | ... | void | 全コンポーネント更新 |
| checkCollisions(entities) | entities: Array | void | 衝突チェック委譲 |
| isSaveable() | - | boolean | 常にfalse |

### PlayerPhysics

**ファイル**: `src/PlayerPhysics.js`
**役割**: プレイヤーの物理演算

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| player | Player | - | プレイヤー参照 |
| velocity | THREE.Vector3 | (0, 0, 0) | 速度ベクトル |
| isGrounded | boolean | false | 接地フラグ |
| gravity | number | -25 | 重力加速度 |
| moveSpeed | number | 5.0 | 移動速度 |
| jumpForce | number | 10 | ジャンプ力 |
| friction | number | 0.9 | 摩擦係数 |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(player) | player: Player | - | 初期化 |
| update(delta, input, collidables) | delta: number, input: object, collidables: Array | void | 物理更新 |
| checkCollisions(collidables) | collidables: Array | void | AABB衝突判定 |
| applyKnockback(direction, force) | direction: THREE.Vector3, force: number | void | ノックバック適用 |
| reset() | - | void | 状態リセット |

### PlayerCombat

**ファイル**: `src/PlayerCombat.js`
**役割**: プレイヤーの戦闘ロジック

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| player | Player | - | プレイヤー参照 |
| sword | THREE.Mesh | - | 剣メッシュ |
| currentState | CombatState | IdleState | 現在のステート |
| attackDuration | number | 0.3 | 攻撃持続時間 |
| attackRange | number | 1.5 | 攻撃範囲 |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(player) | player: Player | - | 初期化 |
| setState(newState) | newState: CombatState | void | ステート変更 |
| update(delta, input, entities) | delta: number, input: object, entities: Array | void | 戦闘更新 |

### PlayerCollision

**ファイル**: `src/PlayerCollision.js`
**役割**: プレイヤーと敵の衝突

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| player | Player | - | プレイヤー参照 |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(player) | player: Player | - | 初期化 |
| checkCollisions(entities, physics) | entities: Array, physics: PlayerPhysics | void | 敵との衝突チェック |

---

## システムクラス

### Input

**ファイル**: `src/Input.js`
**役割**: 入力の統合管理

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| renderer | THREE.WebGLRenderer | - | レンダラー参照 |
| activeKeys | Set<string> | new Set() | アクティブなアクション |
| mouseDown | boolean | false | 左クリック状態 |
| rightMouseDown | boolean | false | 右クリック状態 |
| mouse | object | {x: 0, y: 0} | マウス座標（正規化） |
| keyMap | object | {...} | キー→アクションマップ |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(renderer) | renderer: THREE.WebGLRenderer | - | 初期化 |
| setupListeners() | - | void | イベントリスナー設定 |
| getState() | - | object | 入力状態オブジェクト取得 |
| handleVRInput(state) | state: object | void | VR入力処理 |

#### getState() 戻り値

```javascript
{
  x: number,           // 移動X軸
  z: number,           // 移動Z軸
  jump: boolean,
  attack: boolean,
  rotateLeft: boolean,
  rotateRight: boolean,
  toggleBuildMode: boolean,
  toggleView: boolean,
  placeBlock: boolean,
  removeBlock: boolean,
  save: boolean,
  load: boolean,
  menu: boolean,
  mouse: { x: number, y: number }
}
```

### CameraManager

**ファイル**: `src/CameraManager.js`
**役割**: カメラの制御

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| camera | THREE.PerspectiveCamera | - | カメラ参照 |
| player | Player | - | プレイヤー参照 |
| renderer | THREE.WebGLRenderer | - | レンダラー参照 |
| isFirstPerson | boolean | false | 一人称視点フラグ |
| toggleCooldown | number | 0 | 切替クールダウン |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(camera, player, renderer) | ... | - | 初期化 |
| toggleView() | - | void | 視点切替 |
| update(delta, input) | delta: number, input: object | void | カメラ更新 |
| resize(width, height) | width: number, height: number | void | リサイズ処理 |

### AudioManager

**ファイル**: `src/AudioManager.js`
**役割**: 効果音の生成・再生

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| ctx | AudioContext | - | Web Audio コンテキスト |
| isMuted | boolean | false | ミュートフラグ |
| bgmNodes | Array | [] | BGMノード配列 |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor() | - | - | 初期化 |
| resumeContext() | - | void | AudioContext再開 |
| playJump() | - | void | ジャンプ音 |
| playAttack() | - | void | 攻撃音 |
| playHit() | - | void | 被弾音 |
| playEnemyDeath() | - | void | 敵死亡音 |
| startBGM() | - | void | BGM開始（未実装） |
| stopBGM() | - | void | BGM停止 |

### BuildSystem

**ファイル**: `src/BuildSystem.js`
**役割**: ブロック配置・削除システム

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| scene | THREE.Scene | - | シーン参照 |
| camera | THREE.PerspectiveCamera | - | カメラ参照 |
| entityManager | EntityManager | - | エンティティ管理参照 |
| collidables | Array | - | 衝突対象配列 |
| player | Player \| null | null | プレイヤー参照 |
| buildMode | boolean | false | ビルドモード |
| buildCooldown | number | 0 | ビルドクールダウン |
| ghostBlock | THREE.Mesh | - | ゴーストブロック |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(scene, camera, entityManager, collidables) | ... | - | 初期化 |
| setPlayer(player) | player: Player | void | プレイヤー設定 |
| createGhostBlock() | - | THREE.Mesh | ゴーストブロック生成 |
| update(delta, input) | delta: number, input: object | void | ビルドシステム更新 |
| getRaycastHit(input) | input: object | object \| null | レイキャスト実行 |
| updateGhostBlock(hit) | hit: object \| null | void | ゴースト位置更新 |
| handleBlockPlacement(input, hit) | input: object, hit: object | void | ブロック配置 |
| handleBlockRemoval(input, hit) | input: object, hit: object | void | ブロック削除 |
| isRemovable(entity) | entity: Entity | boolean | 削除可能判定 |
| removeBlock(block) | block: Block | void | ブロック削除実行 |

### WorldManager

**ファイル**: `src/WorldManager.js`
**役割**: ワールドの初期生成

#### プロパティ

| プロパティ | 型 | 初期値 | 説明 |
|-----------|-----|--------|------|
| entityManager | EntityManager | - | エンティティ管理参照 |
| collidables | Array | - | 衝突対象配列 |

#### メソッド

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| constructor(entityManager, collidables) | ... | - | 初期化 |
| populate() | - | void | ワールド生成 |

---

## 関連ドキュメント

- [[02_アーキテクチャ設計|前: アーキテクチャ設計]]
- [[04_エンティティシステム設計|次: エンティティシステム設計]]
- [[_MOC_設計書|設計書目次]]

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-11-23 | 初版作成 |
