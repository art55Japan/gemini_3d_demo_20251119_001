---
tags:
  - è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨
  - JavaScript
  - ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘
  - é–¢æ•°å‹
  - é…åˆ—æ“ä½œ
chapter: 2
status: å®Œäº†
prev: "[[01_ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®åŸºç¤_Entity.js]]"
next: "[[03_ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¨­è¨ˆ_Player.js]]"
source_file: src/EntityManager.js
created: 2025-11-23
---

# ç¬¬2ç« : ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç®¡ç† - EntityManager.js

> [!abstract] ã“ã®ç« ã®æ¦‚è¦
> è¤‡æ•°ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç®¡ç†ã™ã‚‹ `EntityManager.js` ã‚’èª­ã¿è§£ãã¾ã™ã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã¨é–¢æ•°å‹ã‚’çµ„ã¿åˆã‚ã›ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãªè¨­è¨ˆã‚’å­¦ã³ã¾ã™ã€‚

---

## ã“ã®ç« ã§å­¦ã¶ã“ã¨

- [ ] é…åˆ—ã«ã‚ˆã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚’ç†è§£ã™ã‚‹
- [ ] for...of ãƒ«ãƒ¼ãƒ—ã‚’ç†è§£ã™ã‚‹
- [ ] å‰Šé™¤ãƒ•ãƒ©ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç†è§£ã™ã‚‹
- [ ] Scene ã¨ã®é€£æºã‚’ç†è§£ã™ã‚‹

---

## ã“ã®ç« ã§å­¦ã¶ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ 

> [!info] ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ 
> - **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘**: ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚‹ã‚«ãƒ—ã‚»ãƒ«åŒ–
> - **é–¢æ•°å‹**: é…åˆ—æ“ä½œï¼ˆä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ«ãƒ¼ãƒ—ï¼‰
> - é–¢é€£: [[07_ä»˜éŒ²/05_ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ æ—©è¦‹è¡¨#é–¢æ•°å‹|ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ æ—©è¦‹è¡¨]]

---

## ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²

> [!note] `EntityManager.js` ã®å½¹å‰²
> ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ **ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ä¸­å¤®ç®¡ç†æ‰€** ã§ã™ã€‚
> - ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é…åˆ—ã§ä¿æŒ
> - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è¿½åŠ ãƒ»å‰Šé™¤ã‚’ç®¡ç†
> - æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã€å…¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã® update ã‚’å‘¼ã³å‡ºã™
> - Three.js ã® Scene ã¨åŒæœŸ

---

## EntityManager ã‚’ã‚‚ã£ã¨ã‚ã‹ã‚Šã‚„ã™ã

### ãªãœ EntityManager ãŒå¿…è¦ãªã®ã‹ï¼Ÿ

ã‚²ãƒ¼ãƒ ã«ã¯æ§˜ã€…ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç™»å ´ã—ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚²ãƒ¼ãƒ ã®ä¸–ç•Œ                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚    ğŸ° ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆ1ä½“ï¼‰                                 â”‚
â”‚    ğŸŸ¢ ã‚¹ãƒ©ã‚¤ãƒ ï¼ˆãŸãã•ã‚“ï¼‰                              â”‚
â”‚    ğŸ§± ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆãŸãã•ã‚“ï¼‰                              â”‚
â”‚    ğŸŒ³ æœ¨ï¼ˆãŸãã•ã‚“ï¼‰                                    â”‚
â”‚    ğŸª¨ å²©ï¼ˆãŸãã•ã‚“ï¼‰                                    â”‚
â”‚                                                         â”‚
â”‚    â†’ åˆè¨ˆã§æ•°åã€œæ•°ç™¾ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼                  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ã“ã‚Œã‚‰ã‚’ **ãƒãƒ©ãƒãƒ©ã«ç®¡ç†** ã™ã‚‹ã¨å¤§å¤‰ãªã“ã¨ã«ãªã‚Šã¾ã™ï¼š

```javascript
// âŒ ãƒãƒ©ãƒãƒ©ã«ç®¡ç†ã™ã‚‹ã¨...
class Game {
    constructor() {
        this.player = new Player();
        this.slime1 = new Slime();
        this.slime2 = new Slime();
        this.slime3 = new Slime();
        this.block1 = new Block();
        this.block2 = new Block();
        // ... 100å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å€‹åˆ¥ã«æ›¸ãï¼Ÿ
    }

    update() {
        this.player.update();
        this.slime1.update();
        this.slime2.update();
        this.slime3.update();
        this.block1.update();
        this.block2.update();
        // ... 100å›æ›¸ãï¼Ÿ
    }
}
```

ãã“ã§ **EntityManager** ã®å‡ºç•ªã§ã™ï¼š

```javascript
// âœ… EntityManager ã§ä¸€æ‹¬ç®¡ç†
class Game {
    constructor() {
        this.entityManager = new EntityManager(this.scene);

        // è¿½åŠ ã™ã‚‹ã ã‘ï¼
        this.entityManager.add(new Player());
        this.entityManager.add(new Slime());
        this.entityManager.add(new Slime());
        this.entityManager.add(new Block());
        // ... ã„ãã‚‰ã§ã‚‚è¿½åŠ å¯èƒ½
    }

    update() {
        // ãŸã£ãŸ1è¡Œã§å…¨å“¡ã‚’æ›´æ–°ï¼
        this.entityManager.update(delta, input, time, collidables);
    }
}
```

### EntityManager ã‚’ç¾å®Ÿä¸–ç•Œã«ä¾‹ãˆã‚‹ã¨

EntityManager ã¯ **å¹¼ç¨šåœ’ã®å…ˆç”Ÿ** ã®ã‚ˆã†ãªå­˜åœ¨ã§ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ« å¹¼ç¨šåœ’ã®å…ˆç”Ÿï¼ˆEntityManagerï¼‰ã®ä»•äº‹                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ğŸ“‹ å‡ºå¸­ç°¿ã‚’ç®¡ç†ï¼ˆentities é…åˆ—ï¼‰                       â”‚
â”‚     â†’ èª°ãŒã„ã‚‹ã‹æŠŠæ¡ã—ã¦ã„ã‚‹                           â”‚
â”‚                                                         â”‚
â”‚  â• å…¥åœ’ã®æ‰‹ç¶šãï¼ˆadd ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰                        â”‚
â”‚     â†’ æ–°ã—ã„å­ãŒæ¥ãŸã‚‰ã€å‡ºå¸­ç°¿ã«è¿½åŠ                    â”‚
â”‚     â†’ æ•™å®¤ï¼ˆSceneï¼‰ã«æ¡ˆå†…                              â”‚
â”‚                                                         â”‚
â”‚  â– é€€åœ’ã®æ‰‹ç¶šãï¼ˆremove ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰                     â”‚
â”‚     â†’ å¸°ã‚‹å­ã¯å‡ºå¸­ç°¿ã‹ã‚‰å‰Šé™¤                           â”‚
â”‚     â†’ æ•™å®¤ï¼ˆSceneï¼‰ã‹ã‚‰é€€å‡º                            â”‚
â”‚                                                         â”‚
â”‚  ğŸ“¢ ä¸€æ–‰ã«å‘¼ã³ã‹ã‘ï¼ˆupdate ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰                   â”‚
â”‚     â†’ ã€Œã¿ã‚“ãªã€œã€æ¬¡ã®æ´»å‹•ã ã‚ˆã€œã€                     â”‚
â”‚     â†’ å…¨å“¡ã«åŒã˜æŒ‡ç¤ºã‚’å‡ºã›ã‚‹                           â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### EntityManager ã®3ã¤ã®è²¬å‹™

```mermaid
graph TD
    subgraph EntityManager["EntityManager ã®è²¬å‹™"]
        A[â‘  ç®¡ç†<br/>èª°ãŒã„ã‚‹ã‹æŠŠæ¡]
        B[â‘¡ åŒæœŸ<br/>3Dä¸–ç•Œã¨é€£æº]
        C[â‘¢ æ›´æ–°<br/>å…¨å“¡ã«æŒ‡ç¤º]
    end

    A --> D[entities é…åˆ—ã§ä¿æŒ]
    B --> E[Scene ã«è¿½åŠ /å‰Šé™¤]
    C --> F[update ã‚’ä¸€æ–‰å‘¼ã³å‡ºã—]
```

| è²¬å‹™ | å…·ä½“çš„ãªå‡¦ç† | ãªãœå¿…è¦ï¼Ÿ |
|------|-------------|-----------|
| **â‘  ç®¡ç†** | é…åˆ—ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¿æŒ | èª°ãŒã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ã¨ä½•ã‚‚ã§ããªã„ |
| **â‘¡ åŒæœŸ** | Scene ã¸ã®è¿½åŠ ãƒ»å‰Šé™¤ | 3Dè¡¨ç¤ºã•ã‚Œãªã„ã¨è¦‹ãˆãªã„ |
| **â‘¢ æ›´æ–°** | å…¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã® update å‘¼ã³å‡ºã— | å‹•ã‹ãªã„ã¨ä½•ã‚‚èµ·ããªã„ |

### add ã¨ remove ã®ä»•çµ„ã¿

#### addï¼ˆè¿½åŠ ï¼‰ã®æµã‚Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  entityManager.add(slime) ã‚’å‘¼ã¶ã¨...                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ã‚¹ãƒ†ãƒƒãƒ—1: é…åˆ—ã«è¿½åŠ                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ entities: [Player, Block, Block]    â”‚               â”‚
â”‚  â”‚                         â†“           â”‚               â”‚
â”‚  â”‚ entities: [Player, Block, Block, Slime] â† è¿½åŠ ï¼   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                         â”‚
â”‚  ã‚¹ãƒ†ãƒƒãƒ—2: 3Dä¸–ç•Œï¼ˆSceneï¼‰ã«ç™»å ´                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Scene ã« slime.mesh ã‚’è¿½åŠ            â”‚               â”‚
â”‚  â”‚ â†’ ç”»é¢ã«ç·‘ã®ã‚¹ãƒ©ã‚¤ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### removeï¼ˆå‰Šé™¤ï¼‰ã®æµã‚Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  entityManager.remove(slime) ã‚’å‘¼ã¶ã¨...                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ã‚¹ãƒ†ãƒƒãƒ—1: é…åˆ—ã‹ã‚‰æ¢ã™                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ entities: [Player, Block, Slime, Block]             â”‚
â”‚  â”‚                           â†‘                         â”‚
â”‚  â”‚                     ã“ã“ã«ã„ãŸï¼ï¼ˆindex = 2ï¼‰       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                         â”‚
â”‚  ã‚¹ãƒ†ãƒƒãƒ—2: é…åˆ—ã‹ã‚‰å‰Šé™¤                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ entities: [Player, Block, Block] â† Slime æ¶ˆãˆãŸï¼  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                         â”‚
â”‚  ã‚¹ãƒ†ãƒƒãƒ—3: 3Dä¸–ç•Œï¼ˆSceneï¼‰ã‹ã‚‰é€€å ´                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Scene ã‹ã‚‰ slime.mesh ã‚’å‰Šé™¤         â”‚               â”‚
â”‚  â”‚ â†’ ç”»é¢ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ ãŒæ¶ˆãˆã‚‹ï¼         â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### update ã®ä»•çµ„ã¿

æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆ1ç§’ã«60å›ï¼‰å‘¼ã°ã‚Œã‚‹ `update` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€å…¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã€Œå‹•ã‘ï¼ã€ã¨æŒ‡ç¤ºã‚’å‡ºã—ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  entityManager.update() ãŒå‘¼ã°ã‚Œã‚‹ã¨...                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  entities: [Player, Slime, Slime, Block, Tree]          â”‚
â”‚               â†“       â†“       â†“       â†“      â†“         â”‚
â”‚            update  update  update  update  update       â”‚
â”‚               â†“       â†“       â†“       â†“      â†“         â”‚
â”‚             ç§»å‹•    è¿½è·¡    è¿½è·¡    ä½•ã‚‚    ä½•ã‚‚        â”‚
â”‚             æ”»æ’ƒ    æ”»æ’ƒ    æ­»äº¡   ã—ãªã„  ã—ãªã„       â”‚
â”‚                              â†“                         â”‚
â”‚                        shouldRemove = true              â”‚
â”‚                              â†“                         â”‚
â”‚                        remove(slime) å®Ÿè¡Œ               â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> [!important] ãƒã‚¤ãƒ³ãƒˆ
> - **åŒã˜ `update()` å‘¼ã³å‡ºã—** ã§ã‚‚ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç¨®é¡ã«ã‚ˆã£ã¦ **é•ã†å‹•ä½œ** ã‚’ã—ã¾ã™
> - ã“ã‚ŒãŒã€Œãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ï¼ˆå¤šæ…‹æ€§ï¼‰ã€ã¨å‘¼ã°ã‚Œã‚‹ä»•çµ„ã¿ã§ã™
> - Player ã¯ç§»å‹•ãƒ»æ”»æ’ƒã€Slime ã¯è¿½è·¡ãƒ»æ”»æ’ƒã€Block ã¯ä½•ã‚‚ã—ãªã„

---

## ã‚³ãƒ¼ãƒ‰å…¨ä½“

```javascript
import * as THREE from 'three';

export class EntityManager {
    constructor(scene) {
        this.scene = scene;
        this.entities = [];
    }

    add(entity) {
        this.entities.push(entity);
        if (entity.mesh) {
            this.scene.add(entity.mesh);
        }
    }

    remove(entity) {
        const index = this.entities.indexOf(entity);
        if (index > -1) {
            this.entities.splice(index, 1);
            if (entity.mesh) {
                this.scene.remove(entity.mesh);
            }
        }
    }

    update(delta, input, time, collidables) {
        for (const entity of this.entities) {
            if (entity.update) {
                entity.update(delta, input, time, collidables, this.entities);
            }
            if (entity.shouldRemove) {
                this.remove(entity);
            }
        }
    }
}
```

> [!tip] ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªè¨­è¨ˆ
> ã‚ãšã‹36è¡Œã§ã€ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç®¡ç†ï¼
> ã‚·ãƒ³ãƒ—ãƒ«ã•ã¯è‰¯ã„è¨­è¨ˆã®è¨¼ã§ã™ã€‚

---

## ã‚³ãƒ¼ãƒ‰è§£èª¬

### ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿

```javascript
export class EntityManager {
    constructor(scene) {
        this.scene = scene;
        this.entities = [];
    }
```

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| `scene` | THREE.Scene | Three.js ã®ã‚·ãƒ¼ãƒ³ï¼ˆ3Dç©ºé–“ï¼‰ |
| `entities` | Array | ç®¡ç†ã™ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®é…åˆ— |

```mermaid
graph TD
    A[EntityManager] --> B[scene]
    A --> C[entities é…åˆ—]
    C --> D[Player]
    C --> E[Slime]
    C --> F[Block]
    C --> G[Tree]
```

> [!info] ãªãœ Scene ã‚’ä¿æŒã™ã‚‹ã®ã‹
> ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è¿½åŠ ãƒ»å‰Šé™¤ã™ã‚‹ã¨ãã€å¯¾å¿œã™ã‚‹ 3D ãƒ¡ãƒƒã‚·ãƒ¥ã‚‚ Scene ã«è¿½åŠ ãƒ»å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

---

### ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: add ãƒ¡ã‚½ãƒƒãƒ‰

```javascript
    add(entity) {
        this.entities.push(entity);
        if (entity.mesh) {
            this.scene.add(entity.mesh);
        }
    }
```

**å‡¦ç†ã®æµã‚Œ:**

```mermaid
sequenceDiagram
    participant G as Game
    participant EM as EntityManager
    participant A as entitiesé…åˆ—
    participant S as Scene

    G->>EM: add(slime)
    EM->>A: push(slime)
    EM->>EM: slime.mesh å­˜åœ¨ç¢ºèª
    EM->>S: add(slime.mesh)
```

| å‡¦ç† | èª¬æ˜ |
|-----|------|
| `this.entities.push(entity)` | é…åˆ—ã®æœ«å°¾ã«è¿½åŠ  |
| `this.scene.add(entity.mesh)` | 3D ãƒ¡ãƒƒã‚·ãƒ¥ã‚’ Scene ã«è¿½åŠ  |

> [!tip] if (entity.mesh) ã®æ„å‘³
> ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒ mesh ã‚’æŒã¤ã¨ã¯é™ã‚Šã¾ã›ã‚“ï¼ˆä¾‹ï¼šéè¡¨ç¤ºã®ãƒˆãƒªã‚¬ãƒ¼ï¼‰ã€‚
> mesh ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ Scene ã«è¿½åŠ ã—ã¾ã™ã€‚

---

### ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: remove ãƒ¡ã‚½ãƒƒãƒ‰

```javascript
    remove(entity) {
        const index = this.entities.indexOf(entity);
        if (index > -1) {
            this.entities.splice(index, 1);
            if (entity.mesh) {
                this.scene.remove(entity.mesh);
            }
        }
    }
```

**å‡¦ç†ã®æµã‚Œ:**

```mermaid
sequenceDiagram
    participant EM as EntityManager
    participant A as entitiesé…åˆ—
    participant S as Scene

    EM->>A: indexOf(entity)
    A->>EM: index (ä¾‹: 3)
    EM->>EM: index > -1 ç¢ºèª
    EM->>A: splice(3, 1)
    EM->>S: remove(entity.mesh)
```

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------|------|
| `indexOf(entity)` | é…åˆ—å†…ã®ä½ç½®ã‚’æ¤œç´¢ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ -1ï¼‰ |
| `splice(index, 1)` | æŒ‡å®šä½ç½®ã‹ã‚‰1è¦ç´ ã‚’å‰Šé™¤ |
| `scene.remove(mesh)` | 3D ãƒ¡ãƒƒã‚·ãƒ¥ã‚’ Scene ã‹ã‚‰å‰Šé™¤ |

**splice ã®å‹•ä½œ:**

```javascript
const arr = ['a', 'b', 'c', 'd'];
arr.splice(1, 1);  // index=1 ã‹ã‚‰ 1å€‹å‰Šé™¤
// arr ã¯ ['a', 'c', 'd'] ã«ãªã‚‹
```

> [!warning] indexOf ã®æˆ»ã‚Šå€¤ã«æ³¨æ„
> è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€`indexOf` ã¯ `-1` ã‚’è¿”ã—ã¾ã™ã€‚
> `if (index > -1)` ã§å­˜åœ¨ç¢ºèªã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚

---

### ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: update ãƒ¡ã‚½ãƒƒãƒ‰

```javascript
    update(delta, input, time, collidables) {
        for (const entity of this.entities) {
            if (entity.update) {
                entity.update(delta, input, time, collidables, this.entities);
            }
            if (entity.shouldRemove) {
                this.remove(entity);
            }
        }
    }
```

**å‡¦ç†ã®æµã‚Œ:**

```mermaid
graph TD
    A[update é–‹å§‹] --> B[for...of ãƒ«ãƒ¼ãƒ—]
    B --> C{entity.update å­˜åœ¨?}
    C -->|Yes| D[entity.update å‘¼ã³å‡ºã—]
    C -->|No| E[ã‚¹ã‚­ãƒƒãƒ—]
    D --> F{shouldRemove?}
    E --> F
    F -->|Yes| G[remove å‘¼ã³å‡ºã—]
    F -->|No| H[æ¬¡ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£]
    G --> H
    H --> B
```

> [!info] for...of ã¨ã¯
> `for...of` ã¯é…åˆ—ã®å„è¦ç´ ã‚’é †ã«å‡¦ç†ã™ã‚‹ãƒ¢ãƒ€ãƒ³ãªæ§‹æ–‡ã§ã™ã€‚
>
> ```javascript
> // å¾“æ¥ã®æ–¹æ³•
> for (let i = 0; i < array.length; i++) {
>     const item = array[i];
> }
>
> // for...ofï¼ˆæ¨å¥¨ï¼‰
> for (const item of array) {
>     // item ã‚’ä½¿ã†
> }
> ```

**ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã®å®Ÿè·µ:**

```javascript
// åŒã˜ entity.update() å‘¼ã³å‡ºã—ã§ã‚‚...
entity.update(delta, input, time, collidables, this.entities);

// Player ãªã‚‰ â†’ Player.update() ãŒå®Ÿè¡Œ
// Slime ãªã‚‰ â†’ Slime.update() ãŒå®Ÿè¡Œ
// Block ãªã‚‰ â†’ Entity.update()ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
```

---

## å‰Šé™¤ãƒ•ãƒ©ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³

> [!info] å‰Šé™¤ãƒ•ãƒ©ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯
> ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å³åº§ã«å‰Šé™¤ã›ãšã€`shouldRemove` ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã€æ›´æ–°ãƒ«ãƒ¼ãƒ—å†…ã§å‰Šé™¤ã™ã‚‹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

**ãªãœå³åº§ã«å‰Šé™¤ã—ãªã„ã®ã‹:**

```javascript
// âŒ å±é™ºãªå³åº§å‰Šé™¤
for (const entity of this.entities) {
    if (someCondition) {
        this.remove(entity);  // é…åˆ—ãŒå¤‰æ›´ã•ã‚Œã‚‹ï¼
    }
    entity.update();  // å‰Šé™¤ã•ã‚ŒãŸè¦ç´ ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼Ÿ
}

// âœ… å‰Šé™¤ãƒ•ãƒ©ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³
for (const entity of this.entities) {
    entity.update();
    if (entity.shouldRemove) {
        this.remove(entity);  // update ã®å¾Œã«å‰Šé™¤
    }
}
```

```mermaid
sequenceDiagram
    participant S as Slime
    participant C as Combat
    participant EM as EntityManager

    C->>S: takeDamage()
    S->>S: hp = 0
    S->>S: shouldRemove = true
    Note over S: ã¾ã å­˜åœ¨ã—ã¦ã„ã‚‹

    EM->>S: update()
    S->>S: æ­»äº¡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç­‰
    EM->>EM: shouldRemove ç¢ºèª
    EM->>EM: remove(slime)
    Note over S: ã“ã“ã§å‰Šé™¤ã•ã‚Œã‚‹
```

---

## è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³: Manager ã‚¯ãƒ©ã‚¹

> [!tip] Manager ãƒ‘ã‚¿ãƒ¼ãƒ³
> è¤‡æ•°ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ã€ŒManagerã€ã¨å‘¼ã¶è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

| å½¹å‰² | èª¬æ˜ |
|-----|------|
| **è¿½åŠ ** | `add()` ã§ç®¡ç†å¯¾è±¡ã«è¿½åŠ  |
| **å‰Šé™¤** | `remove()` ã§ç®¡ç†å¯¾è±¡ã‹ã‚‰å‰Šé™¤ |
| **æ›´æ–°** | `update()` ã§å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–° |
| **æ¤œç´¢** | å¿…è¦ã«å¿œã˜ã¦ `find()` ã‚„ `filter()` ã‚’æä¾› |

**ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® Manager:**

- `EntityManager`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç®¡ç†
- `AudioManager`: ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†
- `SaveManager`: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ç®¡ç†
- `CameraManager`: ã‚«ãƒ¡ãƒ©ç®¡ç†

---

## Game.js ã¨ã®é€£æº

```javascript
// Game.js
constructor() {
    this.entityManager = new EntityManager(this.scene);

    // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è¿½åŠ 
    this.player = new Player(this.scene, this.audioManager);
    this.entityManager.add(this.player);
}

render() {
    // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
    this.entityManager.update(delta, inputState, time, this.collidables);
}
```

```mermaid
graph LR
    A[Game.js] --> B[EntityManager]
    B --> C[Player]
    B --> D[Slime]
    B --> E[Block]
    A --> F[æ¯ãƒ•ãƒ¬ãƒ¼ãƒ  update]
    F --> B
```

---

## å®Ÿé¨“ã—ã¦ã¿ã‚ˆã†

> [!question] ã‚„ã£ã¦ã¿ã‚ˆã†

### å®Ÿé¨“1: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ•°ã‚’ç¢ºèª

```javascript
// Game.js ã® render() å†…ã«è¿½åŠ 
console.log('ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•°:', this.entityManager.entities.length);
```

### å®Ÿé¨“2: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å‹ã‚’ç¢ºèª

```javascript
// Game.js ã® render() å†…ã«è¿½åŠ 
this.entityManager.entities.forEach(e => console.log(e.type));
```

### å®Ÿé¨“3: å‰Šé™¤ã®å‹•ä½œã‚’ç¢ºèª

```javascript
// Slime.js ã® update() å†…ã«è¿½åŠ 
console.log('Slime shouldRemove:', this.shouldRemove);
```

---

## ã‚ˆãã‚ã‚‹ç–‘å•

> [!question] Q: ãªãœé…åˆ—ã‚’ä½¿ã†ã®ã§ã™ã‹ï¼Ÿã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãƒ€ãƒ¡ï¼Ÿ
> A: é…åˆ—ã¯ **é †åºã‚’ä¿æŒ** ã—ã€**for...of ã§ç°¡å˜ã«åå¾©** ã§ãã¾ã™ã€‚é †åºãŒé‡è¦ã§ã‚­ãƒ¼ãŒä¸è¦ãªå ´åˆã¯é…åˆ—ãŒé©ã—ã¦ã„ã¾ã™ã€‚

> [!question] Q: `if (entity.update)` ã¯ä½•ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
> A: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒ `update` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã„ã¾ã™ã€‚JavaScript ã§ã¯å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ã€äº‹å‰ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚

> [!question] Q: ãƒ«ãƒ¼ãƒ—ä¸­ã«é…åˆ—ã‚’å¤‰æ›´ã—ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿ
> A: ä¸€èˆ¬çš„ã«ã¯å±é™ºã§ã™ãŒã€ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ `update()` ã®**å¾Œã«** `remove()` ã‚’å‘¼ã‚“ã§ã„ã‚‹ãŸã‚ã€ç¾åœ¨ã®åå¾©ã¯å®‰å…¨ã«å®Œäº†ã—ã¾ã™ã€‚ãŸã ã—ã€å‰Šé™¤ã•ã‚ŒãŸè¦ç´ ã®æ¬¡ã®è¦ç´ ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

---

## ç™ºå±•: ã‚ˆã‚Šå®‰å…¨ãªå‰Šé™¤

> [!note] ç™ºå±•çš„ãªå†…å®¹
> æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚ˆã‚Šå®‰å…¨ãªå‰Šé™¤æ–¹æ³•ã‚’ä½¿ã†ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

```javascript
// æ–¹æ³•1: é€†é †ãƒ«ãƒ¼ãƒ—
for (let i = this.entities.length - 1; i >= 0; i--) {
    const entity = this.entities[i];
    entity.update();
    if (entity.shouldRemove) {
        this.entities.splice(i, 1);
    }
}

// æ–¹æ³•2: filter ã§æ–°ã—ã„é…åˆ—ã‚’ä½œæˆ
update() {
    this.entities.forEach(e => e.update());
    this.entities = this.entities.filter(e => !e.shouldRemove);
}
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨ï¼š

- âœ… é…åˆ—ã§è¤‡æ•°ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†
- âœ… `push()` ã§è¿½åŠ ã€`splice()` ã§å‰Šé™¤
- âœ… `for...of` ã§é…åˆ—ã‚’åå¾©
- âœ… å‰Šé™¤ãƒ•ãƒ©ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®‰å…¨ã«å‰Šé™¤
- âœ… Manager ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å½¹å‰²

> [!success] æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
> [[03_ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¨­è¨ˆ_Player.js]] ã«é€²ã‚“ã§ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®è¨­è¨ˆã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

---

## é–¢é€£ãƒªãƒ³ã‚¯

- [[01_ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®åŸºç¤_Entity.js|å‰ã®ç« : ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®åŸºç¤]]
- [[03_ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¨­è¨ˆ_Player.js|æ¬¡ã®ç« : ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¨­è¨ˆ]]
- [[03_è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨/_MOC_è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨|ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç›®æ¬¡ã«æˆ»ã‚‹]]
- [[07_ä»˜éŒ²/01_JavaScriptåŸºç¤ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹|JavaScriptåŸºç¤ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹]]
