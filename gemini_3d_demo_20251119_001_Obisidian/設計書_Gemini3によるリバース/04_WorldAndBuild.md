# ワールド・建築システム

## ワールド生成 (WorldManager)
- **プロシージャル生成**: ゲーム開始時に `populate()` メソッドでエンティティをランダム配置。
- **配置ロジック**:
  - `Tree`: 20本生成。中心から3ユニット以内を除外。
  - `Rock`: 15個生成。中心から2ユニット以内を除外。スケールをランダム化 (0.5 ~ 1.5)。
  - `Slime`: 10体生成。中心から5ユニット以内を除外。
- **除外エリア**: プレイヤーの初期スポーン地点（中心付近）を安全地帯とするため、座標フィルタリングを行っている。

## 建築システム (BuildSystem)
- **モード切替**: `B` キーで建築モード (`buildMode`) の ON/OFF を切り替え。
- **ゴーストブロック**: 設置予定場所に半透明の緑色ブロックを表示。
- **レイキャスト**:
  - マウス位置からカメラを通してレイを飛ばす。
  - 地面 (`y=0` 平面) および既存のエンティティ（プレイヤー以外）との交差を判定。
  - 交差点と法線ベクトルから、ブロックを配置すべきグリッド座標を計算。
- **ブロック配置**:
  - 左クリック (`placeBlock`) で `Block` エンティティを生成・追加。
  - 生成されたブロックは `collidables` 配列に追加され、物理衝突の対象となる。
- **ブロック削除**:
  - 右クリック (`removeBlock`) で対象エンティティを削除。
  - `isRemovable` チェックにより、ブロックのみ削除可能（木や岩は不可）。

## セーブ・ロードシステム (SaveManager)
- **データ構造**: JSON形式で保存。
  ```json
  {
    "timestamp": 1234567890,
    "summary": "Player at 10, 5",
    "player": { "position": [x, y, z], "rotation": y },
    "blocks": [ { "type": "block", "x": 1, "y": 0, "z": 1, "blockType": "dirt" }, ... ],
    "enemies": [ { "type": "slime", "x": 5, "z": 5 }, ... ]
  }
  ```
- **ストレージ**: ブラウザの `localStorage` を使用。
  - キープレフィックス: `gemini_3d_save_` (スロット保存), `gemini_3d_quick_save` (クイック保存)
- **ポリモーフィズム**:
  - 保存時: `entityManager` 内の `isSaveable()` が true のエンティティのみ `toSaveData()` でデータ化。
  - ロード時: `isSaveable()` が true の既存エンティティを削除し、保存データから `fromSaveData()` で再生成。
  - 非保存エンティティ（木、岩）はロード時も維持される。

## UI (SaveLoadUI)
- DOM要素を直接生成してオーバーレイ表示。
- 機能: 新規セーブ、上書きセーブ、ロード、削除。
- `M` キーでメニュー開閉。
